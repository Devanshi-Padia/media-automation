{% extends "layouts/base.html" %}

{% block title %} Review Project {% endblock %}

{% block content %}
<style>
  #textEdit:focus {
      color: #ffffff !important;
      -webkit-text-fill-color: #ffffff !important;
      background-color: #2c2e33 !important;
  }
  
  
  #textEdit {
      color: #000000 !important;
      -webkit-text-fill-color: #000000 !important;
      min-height: 400px !important;
      height: 400px !important;
  }
  
  #textEdit::placeholder {
      color: #6c7293 !important;
  }
  
  .platform-text {
      text-align: justify !important;
      text-justify: inter-word;
  }
  
  .card-body { 
      text-align: justify;
  }
  
  .preview-content {
      text-align: justify;
  }

  /* Platform-specific preview styles */
  .platform-preview-content {
    width: 100%;
    max-width: 100%;
  }

  /* Twitter/X Preview */
  .twitter-preview {
    background: #ffffff;
    color: #000000;
    border-radius: 12px;
    padding: 12px;
    font-size: 14px;
    line-height: 1.4;
  }

  .twitter-post {
    width: 100%;
  }

  .twitter-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .twitter-user-info {
    flex: 1;
  }

  .twitter-name {
    font-weight: 700;
    font-size: 14px;
    color: #000000;
  }

  .twitter-handle {
    color: #536471;
    font-size: 12px;
  }

  .twitter-content {
    margin-bottom: 8px;
    line-height: 1.4;
    color: #000000;
  }

  .twitter-image {
    margin-bottom: 8px;
  }

  .twitter-image img {
    width: 100%;
    border-radius: 8px;
  }

  .twitter-actions {
    display: flex;
    gap: 16px;
    color: #536471;
    font-size: 12px;
  }

  .twitter-action {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  /* Telegram Preview */
  .telegram-preview {
    background: #ffffff;
    border-radius: 8px;
    padding: 12px;
  }

  .telegram-message {
    display: flex;
    gap: 8px;
    align-items: flex-start;
  }

  .telegram-avatar {
    flex-shrink: 0;
  }

  .telegram-content {
    flex: 1;
    min-width: 0;
  }

  .telegram-name {
    font-size: 12px;
    font-weight: 600;
    color: #000000;
    margin-bottom: 4px;
  }

  .telegram-text {
    font-size: 14px;
    color: #000000;
    line-height: 1.4;
    margin-bottom: 8px;
  }

  .telegram-image {
    margin-top: 8px;
  }

  .telegram-image img {
    max-width: 100%;
    border-radius: 4px;
  }

  .telegram-time {
    font-size: 11px;
    color: #666666;
  }

  /* Instagram Preview */
  .instagram-preview {
    background: #ffffff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .instagram-post {
    width: 100%;
  }

  .instagram-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
  }

  .instagram-user {
    font-weight: 600;
    font-size: 14px;
  }

  .instagram-image {
    width: 100%;
  }

  .instagram-image img {
    width: 100%;
    height: auto;
  }

  .instagram-actions {
    display: flex;
    gap: 16px;
    padding: 8px 12px;
    font-size: 20px;
  }

  .instagram-likes {
    font-weight: 600;
    font-size: 14px;
    padding: 0 12px;
  }

  .instagram-caption {
    padding: 0 12px 12px;
    font-size: 14px;
    line-height: 1.4;
    color: #262626;
  }

  .instagram-username {
    font-weight: 600;
  }

  /* Facebook Preview */
  .facebook-preview {
    background: #ffffff;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .facebook-post {
    width: 100%;
  }

  .facebook-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .facebook-user-info {
    flex: 1;
  }

  .facebook-name {
    font-weight: 600;
    font-size: 14px;
  }

  .facebook-time {
    font-size: 12px;
    color: #65676b;
  }

  .facebook-content {
    margin-bottom: 8px;
    line-height: 1.4;
    color: #1c1e21;
  }

  .facebook-image {
    margin-bottom: 8px;
  }

  .facebook-image img {
    width: 100%;
    border-radius: 8px;
  }

  .linkedin-image img {
    width: 100%;
    border-radius: 8px;
  }

  .instagram-image img {
    width: 100%;
    height: auto;
  }

  .telegram-image img {
    max-width: 100%;
    border-radius: 4px;
  }

  .discord-image img {
    max-width: 100%;
    border-radius: 4px;
  }

  .facebook-actions {
    display: flex;
    gap: 16px;
    padding-top: 8px;
    border-top: 1px solid #e4e6eb;
  }

  .facebook-action {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: #65676b;
  }

  /* LinkedIn Preview */
  .linkedin-preview {
    background: #ffffff;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #e0e0e0;
  }

  .linkedin-post {
    width: 100%;
  }

  .linkedin-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .linkedin-user-info {
    flex: 1;
  }

  .linkedin-name {
    font-weight: 600;
    font-size: 14px;
  }

  .linkedin-title {
    font-size: 12px;
    color: #666;
  }

  .linkedin-time {
    font-size: 12px;
    color: #666;
  }

  .linkedin-content {
    margin-bottom: 8px;
    line-height: 1.4;
    color: #1c1e21;
  }

  .linkedin-image {
    margin-bottom: 8px;
  }

  .linkedin-image img {
    width: 100%;
    border-radius: 8px;
  }

  .linkedin-actions {
    display: flex;
    gap: 16px;
    padding-top: 8px;
    border-top: 1px solid #e0e0e0;
  }

  .linkedin-action {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: #666;
  }

  /* Discord Preview */
  .discord-preview {
    background: #ffffff;
    color: #000000;
    border-radius: 8px;
    padding: 12px;
  }

  .discord-message {
    display: flex;
    gap: 8px;
    align-items: flex-start;
  }

  .discord-avatar {
    flex-shrink: 0;
  }

  .discord-content {
    flex: 1;
    min-width: 0;
  }

  .discord-name {
    font-size: 12px;
    font-weight: 600;
    color: #000000;
    margin-bottom: 4px;
  }

  .discord-text {
    font-size: 14px;
    color: #000000;
    line-height: 1.4;
    margin-bottom: 8px;
  }

  .discord-image {
    margin-top: 8px;
  }

  .discord-image img {
    max-width: 100%;
    border-radius: 4px;
  }

  .discord-time {
    font-size: 11px;
    color: #666666;
  }

  /* Default Preview */
  .default-preview {
    background: #ffffff;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    color: #000000;
  }

  .default-preview .platform-text {
    color: #000000 !important;
  }

  /* Platform-specific card styling - colored headers */
  .platform-preview-telegram .card-body {
    background: linear-gradient(135deg, #0088cc, #006699);
    color: #ffffff;
  }

  .platform-preview-x .card-body {
    background: linear-gradient(135deg, #1da1f2, #0d8bd9);
    color: #ffffff;
  }

  .platform-preview-instagram .card-body {
    background: linear-gradient(135deg, #e4405f, #c13584);
    color: #ffffff;
  }

  .platform-preview-facebook .card-body {
    background: linear-gradient(135deg, #1877f2, #0d6efd);
    color: #ffffff;
  }

  .platform-preview-linkedin .card-body {
    background: linear-gradient(135deg, #0077b5, #005885);
    color: #ffffff;
  }

  .platform-preview-discord .card-body {
    background: linear-gradient(135deg, #5865f2, #4752c4);
    color: #ffffff;
  }

  /* All platform preview cards should be white with black text */
  .platform-preview-telegram .telegram-preview,
  .platform-preview-x .twitter-preview,
  .platform-preview-instagram .instagram-preview,
  .platform-preview-facebook .facebook-preview,
  .platform-preview-linkedin .linkedin-preview,
  .platform-preview-discord .discord-preview {
    background: #ffffff !important;
    color: #000000 !important;
  }

  .platform-preview-telegram .telegram-preview *,
  .platform-preview-x .twitter-preview *,
  .platform-preview-instagram .instagram-preview *,
  .platform-preview-facebook .facebook-preview *,
  .platform-preview-linkedin .linkedin-preview *,
  .platform-preview-discord .discord-preview * {
    color: #000000 !important;
  }

  /* Specific text elements in white cards */
  .telegram-text {
    color: #000000 !important;
  }

  .telegram-name {
    color: #000000 !important;
  }

  .telegram-time {
    color: #666666 !important;
  }

  .twitter-content {
    color: #000000 !important;
  }

  .twitter-handle {
    color: #536471 !important;
  }

  .instagram-caption {
    color: #262626 !important;
  }

  .instagram-username {
    color: #262626 !important;
  }

  .facebook-content {
    color: #1c1e21 !important;
  }

  .facebook-name {
    color: #1c1e21 !important;
  }

  .facebook-time {
    color: #65676b !important;
  }

  .linkedin-content {
    color: #1c1e21 !important;
  }

  .linkedin-name {
    color: #1c1e21 !important;
  }

  .linkedin-title {
    color: #666 !important;
  }

  .linkedin-time {
    color: #666 !important;
  }

  .discord-text {
    color: #000000 !important;
  }

  .discord-name {
    color: #000000 !important;
  }

  .discord-time {
    color: #666666 !important;
  }

  /* Exception for images and icons - keep their original colors */
  .platform-preview-telegram img,
  .platform-preview-x img,
  .platform-preview-instagram img,
  .platform-preview-facebook img,
  .platform-preview-linkedin img,
  .platform-preview-discord img,
  .platform-preview-telegram i,
  .platform-preview-x i,
  .platform-preview-instagram i,
  .platform-preview-facebook i,
  .platform-preview-linkedin i,
  .platform-preview-discord i {
    color: inherit !important;
  }

  /* Default Preview */
  .default-preview {
    background: #ffffff;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    color: #000000;
  }

  .default-preview .platform-text {
    color: #000000 !important;
  }
</style>
  
<div class="content-wrapper position-relative">
  <!-- Delete button on top right -->
  <form id="delete-project-form" class="position-absolute" style="top: 50px; right: 50px; z-index: 10;" onsubmit="return deleteProject(event);">
    <button type="submit" class="btn btn-danger">Delete Project</button>
  </form>
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body bg-dark">
          <h2 class="card-title">Review and Edit Generated Content</h2>
          <div class="row mb-4">
            {% if project.with_image %}
            <!-- Left Card: Image Preview -->
            <div class="col-md-6">
              <div class="card h-100 shadow rounded">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title">Image Preview</h5>
                  <div class="flex-grow-1 d-flex align-items-center justify-content-center mb-3">
                    <img id="imagePreview" src="{{ image_path }}" alt="Generated Image" class="img-fluid rounded" style="max-height: 400px;">
                  </div>
                  <form id="editImageForm" onsubmit="return generateNewImage(event);" class="mt-auto">
                    <button type="submit" class="btn btn-primary mt-3 w-100">Generate New Image</button>
                  </form>
                </div>
              </div>
            </div>
            {% endif %}
          
            <!-- Right Card: Text Content Edit -->
            <div class="{% if project.with_image %}col-md-6{% else %}col-md-12{% endif %}">
              <div class="card h-100 shadow rounded">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title">Text Content</h5>
                  <form id="editForm" method="post" action="/projects/{{ project.id }}/edit-text" class="flex-grow-1 d-flex flex-column">
                    <div class="form-group flex-grow-1">
                      {% if generated_text is mapping %}
                      <textarea class="form-control h-100" id="textEdit" name="new_text" style="resize: none;">{% if generated_text['facebook'] is defined -%}{{ generated_text['facebook'] }}{%- else -%}{{ generated_text.values()|list|first }}{%- endif -%}</textarea>
                      {% else %}
                      <textarea class="form-control h-100" id="textEdit" name="new_text" style="resize: none;">{{ generated_text }}</textarea>
                      {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary mt-3 w-100">Save Edits</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          
          
          
          <div class="social-cards-container mt-4 d-flex flex-wrap justify-content-start" id="socialCardsContainer" style="gap: 24px;">
            {% for platform in project.social_medias.replace(', ', ',').split(',') %}
            <div class="card mb-3 social-card platform-preview-{{ platform.lower() }}" data-platform="{{ platform }}" style="width: 320px; min-width: 280px; max-width: 100%; border-radius: 20px;">
              <div class="card-body" style="padding: 1.5rem;">
                <div class="d-flex align-items-center mb-3">
                  <h4 class="card-title mb-0">
                    {% if platform.lower() == 'x' %}
                      <i class="mdi mdi-twitter"></i> X (Twitter)
                    {% elif platform.lower() == 'telegram' %}
                      <i class="mdi mdi-telegram"></i> Telegram
                    {% elif platform.lower() == 'instagram' %}
                      <i class="mdi mdi-instagram"></i> Instagram
                    {% elif platform.lower() == 'facebook' %}
                      <i class="mdi mdi-facebook"></i> Facebook
                    {% elif platform.lower() == 'linkedin' %}
                      <i class="mdi mdi-linkedin"></i> LinkedIn
                    {% elif platform.lower() == 'discord' %}
                      <i class="mdi mdi-discord"></i> Discord
                    {% else %}
                      {{ platform }}
                    {% endif %}
                  </h4>
                </div>
                <div class="preview-content d-flex flex-column align-items-center">
                  {% set platform_key = platform.lower() %}
                  {% if platform_key == 'x' %}
                    {% if generated_text['x'] is defined and generated_text['x']|default('')|trim %}
                      <div class="platform-preview-content twitter-preview">
                        <div class="twitter-post">
                          <div class="twitter-header">
                            <i class="mdi mdi-account-circle" style="font-size: 24px; color: #1da1f2;"></i>
                            <div class="twitter-user-info">
                              <div class="twitter-name">Your Account</div>
                              <div class="twitter-handle">@youraccount</div>
                            </div>
                          </div>
                          {% if project.with_image %}
                            <div class="twitter-image">
                              <img src="{{ image_path }}" alt="Twitter Image" class="img-fluid rounded">
                            </div>
                          {% endif %}
                          <div class="twitter-content">{{ generated_text['x'] }}</div>
                          <div class="twitter-actions">
                            <span class="twitter-action"><i class="mdi mdi-message-outline"></i> 0</span>
                            <span class="twitter-action"><i class="mdi mdi-repeat"></i> 0</span>
                            <span class="twitter-action"><i class="mdi mdi-heart-outline"></i> 0</span>
                          </div>
                        </div>
                      </div>
                    {% elif generated_text['twitter'] is defined and generated_text['twitter']|default('')|trim %}
                      <div class="platform-preview-content twitter-preview">
                        <div class="twitter-post">
                          <div class="twitter-header">
                            <i class="mdi mdi-account-circle" style="font-size: 24px; color: #1da1f2;"></i>
                            <div class="twitter-user-info">
                              <div class="twitter-name">Your Account</div>
                              <div class="twitter-handle">@youraccount</div>
                            </div>
                          </div>
                          {% if project.with_image %}
                            <div class="twitter-image">
                              <img src="{{ image_path }}" alt="Twitter Image" class="img-fluid rounded">
                            </div>
                          {% endif %}
                          <div class="twitter-content">{{ generated_text['twitter'] }}</div>
                          <div class="twitter-actions">
                            <span class="twitter-action"><i class="mdi mdi-message-outline"></i> 0</span>
                            <span class="twitter-action"><i class="mdi mdi-repeat"></i> 0</span>
                            <span class="twitter-action"><i class="mdi mdi-heart-outline"></i> 0</span>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="platform-preview-content twitter-preview">
                        <div class="twitter-post">
                          <div class="twitter-header">
                            <i class="mdi mdi-account-circle" style="font-size: 24px; color: #1da1f2;"></i>
                            <div class="twitter-user-info">
                              <div class="twitter-name">Your Account</div>
                              <div class="twitter-handle">@youraccount</div>
                            </div>
                          </div>
                          {% if project.with_image %}
                            <div class="twitter-image">
                              <img src="{{ image_path }}" alt="Twitter Image" class="img-fluid rounded">
                            </div>
                          {% endif %}
                          <div class="twitter-content">{{ project.topic }}</div>
                          <div class="twitter-actions">
                            <span class="twitter-action"><i class="mdi mdi-message-outline"></i> 0</span>
                            <span class="twitter-action"><i class="mdi mdi-repeat"></i> 0</span>
                            <span class="twitter-action"><i class="mdi mdi-heart-outline"></i> 0</span>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% elif platform_key == 'telegram' %}
                    {% if generated_text['telegram'] is defined and generated_text['telegram']|default('')|trim %}
                      <div class="platform-preview-content telegram-preview">
                        <div class="telegram-message">
                          <div class="telegram-avatar">
                            <i class="mdi mdi-account-circle" style="font-size: 32px; color: #0088cc;"></i>
                          </div>
                          <div class="telegram-content">
                            <div class="telegram-name">Your Bot</div>
                            <div class="telegram-text">{{ generated_text['telegram'] }}</div>
                            {% if project.with_image %}
                              <div class="telegram-image">
                                <img src="{{ image_path }}" alt="Telegram Image" class="img-fluid rounded">
                              </div>
                            {% endif %}
                            <div class="telegram-time">12:34</div>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="platform-preview-content telegram-preview">
                        <div class="telegram-message">
                          <div class="telegram-avatar">
                            <i class="mdi mdi-account-circle" style="font-size: 32px; color: #0088cc;"></i>
                          </div>
                          <div class="telegram-content">
                            <div class="telegram-name">Your Bot</div>
                            <div class="telegram-text">{{ project.topic }}</div>
                            {% if project.with_image %}
                              <div class="telegram-image">
                                <img src="{{ image_path }}" alt="Telegram Image" class="img-fluid rounded">
                              </div>
                            {% endif %}
                            <div class="telegram-time">12:34</div>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% elif platform_key == 'instagram' %}
                    {% if generated_text['instagram'] is defined and generated_text['instagram']|default('')|trim %}
                      <div class="platform-preview-content instagram-preview">
                        <div class="instagram-post">
                          <div class="instagram-header">
                            <i class="mdi mdi-account-circle" style="font-size: 24px; color: #e4405f;"></i>
                            <div class="instagram-user">youraccount</div>
                          </div>
                          {% if project.with_image %}
                            <div class="instagram-image">
                              <img src="{{ image_path }}" alt="Instagram Post" class="img-fluid">
                            </div>
                          {% endif %}
                          <div class="instagram-actions">
                            <i class="mdi mdi-heart-outline"></i>
                            <i class="mdi mdi-message-outline"></i>
                            <i class="mdi mdi-send"></i>
                          </div>
                          <div class="instagram-likes">1,234 likes</div>
                          <div class="instagram-caption">
                            <span class="instagram-username">youraccount</span> {{ generated_text['instagram'] }}
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="platform-preview-content instagram-preview">
                        <div class="instagram-post">
                          <div class="instagram-header">
                            <i class="mdi mdi-account-circle" style="font-size: 24px; color: #e4405f;"></i>
                            <div class="instagram-user">youraccount</div>
                          </div>
                          {% if project.with_image %}
                            <div class="instagram-image">
                              <img src="{{ image_path }}" alt="Instagram Post" class="img-fluid">
                            </div>
                          {% endif %}
                          <div class="instagram-actions">
                            <i class="mdi mdi-heart-outline"></i>
                            <i class="mdi mdi-message-outline"></i>
                            <i class="mdi mdi-send"></i>
                          </div>
                          <div class="instagram-likes">1,234 likes</div>
                          <div class="instagram-caption">
                            <span class="instagram-username">youraccount</span> {{ project.topic }}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% elif platform_key == 'facebook' %}
                    {% if generated_text['facebook'] is defined and generated_text['facebook']|default('')|trim %}
                      <div class="platform-preview-content facebook-preview">
                        <div class="facebook-post">
                          <div class="facebook-header">
                            <i class="mdi mdi-account-circle" style="font-size: 24px; color: #1877f2;"></i>
                            <div class="facebook-user-info">
                              <div class="facebook-name">Your Name</div>
                              <div class="facebook-time">2 hours ago</div>
                            </div>
                          </div>
                          <div class="facebook-content">{{ generated_text['facebook'] }}</div>
                          {% if project.with_image %}
                            <div class="facebook-image">
                              <img src="{{ image_path }}" alt="Facebook Post" class="img-fluid">
                            </div>
                          {% endif %}
                          <div class="facebook-actions">
                            <span class="facebook-action"><i class="mdi mdi-thumb-up-outline"></i> Like</span>
                            <span class="facebook-action"><i class="mdi mdi-message-outline"></i> Comment</span>
                            <span class="facebook-action"><i class="mdi mdi-share"></i> Share</span>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="platform-preview-content facebook-preview">
                        <div class="facebook-post">
                          <div class="facebook-header">
                            <i class="mdi mdi-account-circle" style="font-size: 24px; color: #1877f2;"></i>
                            <div class="facebook-user-info">
                              <div class="facebook-name">Your Name</div>
                              <div class="facebook-time">2 hours ago</div>
                            </div>
                          </div>
                          <div class="facebook-content">{{ project.topic }}</div>
                          {% if project.with_image %}
                            <div class="facebook-image">
                              <img src="{{ image_path }}" alt="Facebook Post" class="img-fluid">
                            </div>
                          {% endif %}
                          <div class="facebook-actions">
                            <span class="facebook-action"><i class="mdi mdi-thumb-up-outline"></i> Like</span>
                            <span class="facebook-action"><i class="mdi mdi-message-outline"></i> Comment</span>
                            <span class="facebook-action"><i class="mdi mdi-share"></i> Share</span>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% elif platform_key == 'linkedin' %}
                    {% if generated_text['linkedin'] is defined and generated_text['linkedin']|default('')|trim %}
                      <div class="platform-preview-content linkedin-preview">
                        <div class="linkedin-post">
                          <div class="linkedin-header">
                            <i class="mdi mdi-account-circle" style="font-size: 24px; color: #0077b5;"></i>
                            <div class="linkedin-user-info">
                              <div class="linkedin-name">Your Name</div>
                              <div class="linkedin-title">Professional Title</div>
                              <div class="linkedin-time">2 hours ago</div>
                            </div>
                          </div>
                          <div class="linkedin-content">{{ generated_text['linkedin'] }}</div>
                          {% if project.with_image %}
                            <div class="linkedin-image">
                              <img src="{{ image_path }}" alt="LinkedIn Post" class="img-fluid">
                            </div>
                          {% endif %}
                          <div class="linkedin-actions">
                            <span class="linkedin-action"><i class="mdi mdi-thumb-up-outline"></i></span>
                            <span class="linkedin-action"><i class="mdi mdi-message-outline"></i></span>
                            <span class="linkedin-action"><i class="mdi mdi-share"></i></span>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="platform-preview-content linkedin-preview">
                        <div class="linkedin-post">
                          <div class="linkedin-header">
                            <i class="mdi mdi-account-circle" style="font-size: 24px; color: #0077b5;"></i>
                            <div class="linkedin-user-info">
                              <div class="linkedin-name">Your Name</div>
                              <div class="linkedin-title">Professional Title</div>
                              <div class="linkedin-time">2 hours ago</div>
                            </div>
                          </div>
                          <div class="linkedin-content">{{ project.topic }}</div>
                          {% if project.with_image %}
                            <div class="linkedin-image">
                              <img src="{{ image_path }}" alt="LinkedIn Post" class="img-fluid">
                            </div>
                          {% endif %}
                          <div class="linkedin-actions">
                            <span class="linkedin-action"><i class="mdi mdi-thumb-up-outline"></i></span>
                            <span class="linkedin-action"><i class="mdi mdi-message-outline"></i></span>
                            <span class="linkedin-action"><i class="mdi mdi-share"></i></span>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% elif platform_key == 'discord' %}
                    {% if generated_text['discord'] is defined and generated_text['discord']|default('')|trim %}
                      <div class="platform-preview-content discord-preview">
                        <div class="discord-message">
                          <div class="discord-avatar">
                            <i class="mdi mdi-account-circle" style="font-size: 32px; color: #5865f2;"></i>
                          </div>
                          <div class="discord-content">
                            <div class="discord-name">Your Bot</div>
                            <div class="discord-text">{{ generated_text['discord'] }}</div>
                            {% if project.with_image %}
                              <div class="discord-image">
                                <img src="{{ image_path }}" alt="Discord Image" class="img-fluid rounded">
                              </div>
                            {% endif %}
                            <div class="discord-time">12:34</div>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="platform-preview-content discord-preview">
                        <div class="discord-message">
                          <div class="discord-avatar">
                            <i class="mdi mdi-account-circle" style="font-size: 32px; color: #5865f2;"></i>
                          </div>
                          <div class="discord-content">
                            <div class="discord-name">Your Bot</div>
                            <div class="discord-text">{{ project.topic }}</div>
                            {% if project.with_image %}
                              <div class="discord-image">
                                <img src="{{ image_path }}" alt="Discord Image" class="img-fluid rounded">
                              </div>
                            {% endif %}
                            <div class="discord-time">12:34</div>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% else %}
                    <div class="platform-preview-content default-preview">
                      <p class="platform-text mt-2 mb-0 text-center">{{ project.topic }}</p>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          
          <div class="d-flex justify-content-center mt-4" style="gap: 16px;">
            <button id="scheduleBtn" class="btn btn-success">Schedule</button>
            <button id="postNowBtn" class="btn btn-primary" onclick="postNow({{ project.id }})">Post Now</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" role="dialog" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scheduleModalLabel">Schedule Project</h5>
        <button type="button" class="close" onclick="closeScheduleModal()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="scheduleForm">
          <div class="form-group">
            <label for="scheduledTime">Schedule Time (IST)</label>
            <input type="datetime-local" class="form-control" id="scheduledTime" name="scheduled_time" required style="color: #ffffff; background-color: #2c2e33;">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeScheduleModal()">Cancel</button>
        <button type="button" id="scheduleProjectBtn" class="btn btn-primary" onclick="scheduleProject()">Schedule Project</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
function authFetch(url, options = {}) {
  return fetch(url, options).then(response => {
    if (response.status === 401 || response.status === 403) {
      window.location.href = '/login';
      return Promise.reject(new Error('Session expired. Redirecting to login.'));
    }
    return response;
  });
}

// Global variable to store current project ID
let currentProjectId = {{ project.id }};

// Add event listener to ensure button works
document.addEventListener('DOMContentLoaded', function() {
  const scheduleBtn = document.getElementById('scheduleBtn');
  if (scheduleBtn) {
    console.log('Schedule button found:', scheduleBtn);
    // Add both onclick and event listener for redundancy
    scheduleBtn.onclick = function() {
      console.log('Schedule button clicked via onclick');
      openScheduleModal();
    };
    scheduleBtn.addEventListener('click', function(e) {
      console.log('Schedule button clicked via event listener');
      e.preventDefault();
      openScheduleModal();
    });
  } else {
    console.error('Schedule button not found!');
  }
  
  // Add modal event listeners for proper closing
  const modal = document.getElementById('scheduleModal');
  if (modal) {
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeScheduleModal();
      }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && !modal.hasAttribute('aria-hidden')) {
        closeScheduleModal();
      }
    });
  }
});

function deleteProject(event) {
  event.preventDefault();
  showCustomConfirm(
    'Are you sure you want to delete this project? This action cannot be undone.',
    function() {
      actuallyDeleteProject(event);
    },
    function() {
      // User cancelled, do nothing
    }
  );
  return false;
}

function actuallyDeleteProject(event) {
  const deleteBtn = event.target.querySelector('button[type="submit"]');
  // Show loading state
  setButtonLoading(deleteBtn, true);
  showLoading('Deleting Project...');
  const projectId = {{ project.id }};
  authFetch(`/api/v1/projects/${projectId}/delete`, {
    method: 'DELETE',
    credentials: 'same-origin',
    headers: {
      'Accept': 'application/json',
    },
  })
  .then(response => {
    if (response.status === 204) {
      showCustomNotification('Project deleted successfully.', 'success');
      // Force refresh dashboard with cache-busting
      setTimeout(() => {
        window.location.href = '/dashboard?refresh=' + new Date().getTime();
      }, 1000);
    } else {
      response.text().then(text => showCustomNotification('Failed to delete project: ' + text, 'error'));
    }
  })
  .catch(error => {
    showCustomNotification('Error deleting project: ' + error, 'error');
  })
  .finally(() => {
    // Hide loading state
    setButtonLoading(deleteBtn, false);
    hideLoading();
  });
}

// Generate new image using previous prompt
function generateNewImage(event) {
  event.preventDefault();
  
  const generateBtn = event.target;
  
  // Show loading state
  setButtonLoading(generateBtn, true);
  showLoading('Generating New Image...');
  
  authFetch('/api/v1/projects/{{ project.id }}/edit-image', {
    method: 'POST',
    headers: { 'Accept': 'application/json' },
  })
  .then(res => res.json())
  .then(data => {
    if (data.image_path) {
      const cacheBuster = '?t=' + new Date().getTime();
      document.getElementById('imagePreview').src = data.image_path + cacheBuster;
      document.querySelectorAll('.preview-image').forEach(img => {
        img.src = data.image_path + cacheBuster;
      });
    }
  })
  .catch(error => {
    console.error('Error generating image:', error);
    showCustomNotification('Error generating new image. Please try again.', 'error');
  })
  .finally(() => {
    setButtonLoading(generateBtn, false);
    hideLoading();
  });
  
  return false;
}

// Save edits and update preview below
// (AJAX update for social cards)
document.getElementById('editForm').onsubmit = function(e) {
  e.preventDefault();
  
  const saveBtn = e.target.querySelector('button[type="submit"]');
  
  // Show loading state
  setButtonLoading(saveBtn, true);
  showLoading('Saving Edits...');
  
  const formData = new FormData(e.target);
  authFetch('/api/v1/projects/{{ project.id }}/edit-text', {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(res => {
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    return res.json();
  })
  .then(data => {
    if (data.status === 'success') {
      showCustomNotification('Text updated successfully!', 'success');
      
      // Update the preview cards with the new text
      const newText = formData.get('new_text');
      let parsed;
      try { 
        parsed = JSON.parse(newText); 
      } catch { 
        parsed = newText; 
      }
      
      document.querySelectorAll('.social-card').forEach(card => {
        const platform = card.getAttribute('data-platform').toLowerCase();
        let text = parsed[platform] || parsed;
        
        // Update the appropriate text element based on platform
        const contentElement = card.querySelector('.twitter-content, .facebook-content, .linkedin-content, .instagram-caption, .telegram-text, .discord-text');
        if (contentElement) {
          contentElement.textContent = text;
        }
      });
    } else {
      throw new Error(data.message || 'Unknown error occurred');
    }
  })
  .catch(error => {
    console.error('Error saving edits:', error);
    showCustomNotification('Error saving edits. Please try again.', 'error');
  })
  .finally(() => {
    setButtonLoading(saveBtn, false);
    hideLoading();
  });
};

function editPost(platform) {
  console.log(`Edit post for ${platform}`);
}

function previewPost(platform) {
  console.log(`Preview post for ${platform}`);
}

function schedulePost(platform) {
  console.log(`Schedule post for ${platform}`);
}

function postNow(projectId) {
  showCustomConfirm(
    'Are you sure you want to post now?',
    function() {
      actuallyPostNow(projectId);
    },
    function() {
      // User cancelled, do nothing
    }
  );
}

function actuallyPostNow(projectId) {
  const postNowBtn = document.getElementById('postNowBtn');
  
  // Show loading state
  setButtonLoading(postNowBtn, true);
  showLoading('Posting to Social Media...');
  console.log('Starting post-now request for project:', projectId);
  
  authFetch(`/api/v1/projects/${projectId}/post-now`, {
    method: 'POST',
    headers: { 'Accept': 'application/json' },
    credentials: 'same-origin',
  })
  .then(response => {
    console.log('Response status:', response.status);
    if (!response.ok) {
      // Handle HTTP error responses (like 500)
      return response.text().then(errorText => {
        console.error('HTTP Error:', response.status, errorText);
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      });
    }
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    if (data.status === 'success') {
        showCustomNotification('Successfully posted to all platforms!', 'success');
        setTimeout(() => window.location.replace('/dashboard'), 1500);
    } else if (data.status === 'partial') {
        const details = data.details || {};
        const success = (details.successful_platforms || []).join(', ');
        const failed = (details.failed_platforms || []).join(', ');
        let msg = '';
        if (success) msg += `Successfully posted to: ${success}.<br>`;
        if (failed) msg += `Failed to post to: ${failed}. Please check your credentials.`;
        showCustomNotification(msg, 'partial');
        setTimeout(() => window.location.replace('/dashboard'), 2500);
    } else {
        showCustomNotification('Failed to post to all platforms. Please check your credentials.', 'error');
        setTimeout(() => window.location.replace('/dashboard'), 3000);
    }
})
  .catch(error => {
    console.error('Posting error:', error);
    let errorMessage = 'Error posting to social media. Please check your credentials and try again.';
    
    // Try to extract more specific error message
    if (error.message && error.message.includes('HTTP 500:')) {
      const errorDetail = error.message.split('HTTP 500:')[1]?.trim();
      if (errorDetail) {
        errorMessage = `Posting failed: ${errorDetail}`;
      }
    }
    
    showCustomNotification(errorMessage, 'error');
    // Redirect to dashboard after showing error
    console.log('Scheduling redirect to dashboard in 3 seconds...');
    setTimeout(() => {
      console.log('Executing redirect to dashboard...');
      window.location.replace('/dashboard');
    }, 3000);
    
    // Fallback redirect after 5 seconds in case setTimeout fails
    setTimeout(() => {
      console.log('Fallback redirect to dashboard...');
      if (window.location.pathname !== '/dashboard') {
        window.location.href = '/dashboard';
      }
    }, 2000);
  })
  .finally(() => {
    console.log('Post-now request completed (finally block)');
    setButtonLoading(postNowBtn, false);
    hideLoading();
  });
}

// Schedule modal functions
function openScheduleModal() {
  // First check if project already has a scheduled post
  authFetch(`/api/v1/tasks/projects/${currentProjectId}/schedule-status`, {
    method: 'GET',
    headers: {
      'Accept': 'application/json'
    },
    credentials: 'include'
  })
  .then(response => response.json())
  .then(data => {
    if (data.has_scheduled_post) {
      // Project already has a scheduled post
      showCustomConfirm(
        `This project already has a scheduled post (ID: ${data.scheduled_post_id}).\n\n` +
        `Would you like to reschedule it to a new time?`,
        function() {
          showScheduleModal(true); // true = reschedule mode
        },
        function() {
          // User cancelled, do nothing
        }
      );
    } else {
      // No scheduled post, proceed normally
      showScheduleModal(false); // false = new schedule mode
    }
  })
  .catch(error => {
    console.error('Error checking schedule status:', error);
    showScheduleModal(false);
  });
}

function showScheduleModal(isReschedule = false) {
  // Set default time to 1 hour from now
  const now = new Date();
  const oneHourLater = new Date(now.getTime());
  
  // Format for datetime-local input (YYYY-MM-DDTHH:MM)
  const year = oneHourLater.getFullYear();
  const month = String(oneHourLater.getMonth() + 1).padStart(2, '0');
  const day = String(oneHourLater.getDate()).padStart(2, '0');
  const hours = String(oneHourLater.getHours()).padStart(2, '0');
  const minutes = String(oneHourLater.getMinutes()).padStart(2, '0');
  
  const timeString = `${year}-${month}-${day}T${hours}:${minutes}`;
  document.getElementById('scheduledTime').value = timeString;
  
  // Update modal title and button text based on mode
  const modalTitle = document.getElementById('scheduleModalLabel');
  const scheduleBtn = document.getElementById('scheduleProjectBtn');
  
  if (isReschedule) {
    modalTitle.textContent = 'Reschedule Project';
    scheduleBtn.textContent = 'Reschedule Project';
  } else {
    modalTitle.textContent = 'Schedule Project';
    scheduleBtn.textContent = 'Schedule Project';
  }
  
  // Show modal using Bootstrap's modal method if available
  const modal = document.getElementById('scheduleModal');
  if (modal) {
    if (typeof $ !== 'undefined' && $.fn.modal) {
      $('#scheduleModal').modal('show');
    } else {
      // Manual modal showing
      modal.removeAttribute('aria-hidden');
      modal.setAttribute('aria-modal', 'true');
      modal.style.display = 'block';
      modal.classList.add('show');
      document.body.classList.add('modal-open');
      
      // Add backdrop
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop fade show';
      backdrop.id = 'modalBackdrop';
      document.body.appendChild(backdrop);
    }
    
    // Focus on the input after modal is shown
    setTimeout(() => {
      const input = document.getElementById('scheduledTime');
      if (input) {
        input.focus();
      }
    }, 100);
  } else {
    console.error('Modal not found');
  }
}

function closeScheduleModal() {
  const modal = document.getElementById('scheduleModal');
  if (modal) {
    // Use Bootstrap's modal hide method if available
    if (typeof $ !== 'undefined' && $.fn.modal) {
      $('#scheduleModal').modal('hide');
    } else {
      // Manual modal hiding
      modal.setAttribute('aria-hidden', 'true');
      modal.removeAttribute('aria-modal');
      modal.style.display = 'none';
      modal.classList.remove('show');
      document.body.classList.remove('modal-open');
      
      // Remove backdrop
      const backdrop = document.getElementById('modalBackdrop');
      if (backdrop) {
        backdrop.remove();
      }
      
      // Also remove any Bootstrap backdrop
      const bootstrapBackdrop = document.querySelector('.modal-backdrop');
      if (bootstrapBackdrop) {
        bootstrapBackdrop.remove();
      }
    }
    
    // Return focus to the schedule button
    const scheduleBtn = document.getElementById('scheduleProjectBtn');
    if (scheduleBtn) {
      scheduleBtn.focus();
    }
    
    // Reset form
    const form = document.getElementById('scheduleForm');
    if (form) {
      form.reset();
    }
  }
}

function scheduleProject() {
  const scheduledTime = document.getElementById('scheduledTime').value;
  if (!scheduledTime) {
    showCustomNotification('Please select a schedule time.', 'error');
    return;
  }
  
  const scheduleBtn = document.getElementById('scheduleProjectBtn');
  const isReschedule = scheduleBtn.textContent === 'Reschedule Project';
  
  // Show loading state
  scheduleBtn.disabled = true;
  scheduleBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2"></span>' + (isReschedule ? 'Rescheduling...' : 'Scheduling...');
  
  // Convert to IST string
  const date = new Date(scheduledTime);
  const istString = date.toISOString();
  
  console.log((isReschedule ? 'Rescheduling' : 'Scheduling') + ' project with time:', istString);
  
  // Choose endpoint based on whether it's a reschedule or new schedule
  const endpoint = isReschedule ? 'reschedule' : 'schedule';
  const method = isReschedule ? 'PUT' : 'POST';
  
  authFetch(`/api/v1/tasks/projects/${currentProjectId}/${endpoint}`, {
    method: method,
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({
      scheduled_time: istString
    }),
    credentials: 'include'
  })
  .then(response => {
    console.log('Response status:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    if (data.status === 'success' || data.status === 'scheduled' || data.status === 'rescheduled') {
      showCustomNotification(isReschedule ? 'Project rescheduled successfully!' : 'Project scheduled successfully!', 'success');
      // Hide modal
      closeScheduleModal();
      // Add a small delay before redirect to ensure modal closes
      setTimeout(() => {
        console.log('Redirecting to dashboard...');
        window.location.replace('/dashboard');
      }, 500);
    } else {
      showCustomNotification('Failed to ' + (isReschedule ? 'reschedule' : 'schedule') + ' project: ' + (data.message || 'Unknown error'), 'error');
    }
  })
  .catch(error => {
    console.error('Error ' + (isReschedule ? 'rescheduling' : 'scheduling') + ' project:', error);
    showCustomNotification('Error ' + (isReschedule ? 'rescheduling' : 'scheduling') + ' project: ' + error.message, 'error');
  })
  .finally(() => {
    // Reset button state
    scheduleBtn.disabled = false;
    scheduleBtn.innerHTML = isReschedule ? 'Reschedule Project' : 'Schedule Project';
  });
}
</script>
{% endblock %}